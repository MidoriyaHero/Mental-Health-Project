<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• ƒê√°nh gi√° S·ª©c kh·ªèe Tinh th·∫ßn</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4a90e2;
            --background-color: #f0f4f8;
            --text-color: #333;
            --tab-inactive-color: #ccc;
            --success-color: #28a745; /* Green for positive results or low negative */
            --warning-color: #ffc107;  /* Yellow for moderate results */
            --danger-color: #dc3545;   /* Red for low positive or high negative results */
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            max-width: 900px; /* Increased max-width for tabs */
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }
        h1, h2, h3 {
            color: var(--primary-color);
        }
        h1 {
            margin-bottom: 5px;
        }
        h1 + p {
            font-style: italic;
            color: #555;
            margin-top: 0;
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--tab-inactive-color);
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            font-size: 1em;
            transition: color 0.3s, border-bottom-color 0.3s;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px; /* Overlap border */
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: bold;
        }
        .tab-content {
            display: none;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
        }
        .tab-content.active {
            display: block;
        }

        /* Form and Question Styles */
        input[type="text"], input[type="date"] {
            width: 100%;
            padding: 10px;
            margin: 5px 0 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px 10px 10px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #357abd;
        }
         button.clear-data-button {
             background-color: #ff0000;
         }
         button.clear-data-button:hover {
             background-color: #750000;
         }

        .question {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            padding-bottom: 40px; /* Space for labels */
        }
        .options {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            position: relative;
        }
        .option {
            flex: 1;
            text-align: center;
            margin: 0 2px;
            border: 2px solid #ddd;
            background-color: #eee; /* Slightly grey for options */
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
            border-radius: 4px;
            padding: 5px 0;
            user-select: none; /* Prevent text selection on click */
        }
         .option:first-child { margin-left: 0; }
         .option:last-child { margin-right: 0; }

        .option.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .label {
            position: absolute;
            bottom: 10px;
            font-size: 0.9em;
            color: #555; /* Less prominent color for scale labels */
            width: calc(100% - 30px); /* Account for padding */
            text-align: center;
            left: 15px; /* Align with padding */
            right: 15px; /* Align with padding */
        }
        .label .left {
            float: left;
        }
         .label .right {
             float: right;
         }
         .label .center {
             /* For DASS-21/GHQ-12 where middle options might have labels */
             display: inline-block;
             margin: 0 auto; /* Doesn't work with floats, might need specific positioning */
         }

         /* Specific Label Adjustments for scales */
         .scale-0-10 .label .left { width: auto; } /* Allow left/right to be natural width */
         .scale-0-10 .label .right { width: auto; }
         .scale-0-10 .label { display: flex; justify-content: space-between; } /* Use flex for 0-10 */

         .scale-0-3 .label { /* Positioning for 0, 1, 2, 3 scales */
            display: flex;
            justify-content: space-between;
            width: calc(100% - 30px);
            left: 15px;
         }
         .scale-0-3 .label span {
             flex: 1;
             text-align: center;
         }


        /* Results Tab Styles */
        #results-content {
             background-color: white;
             border: 1px solid #ddd;
             border-radius: 4px;
             padding: 15px;
        }

         #results-content h3 {
             margin-top: 20px;
             margin-bottom: 10px;
             border-bottom: 1px solid #eee;
             padding-bottom: 5px;
         }

         .result-section {
             margin-bottom: 20px;
             padding-bottom: 20px;
             border-bottom: 1px dashed #ddd;
         }
         .result-section:last-child {
             border-bottom: none;
             margin-bottom: 0;
             padding-bottom: 0;
         }

        .result-item {
            margin-bottom: 10px;
        }
        .result-item strong {
            color: var(--primary-color);
        }
        .result-item .score {
            font-weight: bold;
            margin-right: 5px;
        }
         .interpretation-text {
             font-size: 0.9em;
             color: #555;
             margin-top: 2px;
         }
          .interpretation-text.low, .interpretation-text.severe, .interpretation-text.very-severe, .interpretation-text.risk {
             color: var(--danger-color);
             font-weight: bold; /* Highlight risk/severe */
          }
           .interpretation-text.medium, .interpretation-text.moderate, .interpretation-text.mild {
              color: var(--warning-color);
              font-weight: bold; /* Highlight warning/moderate */
           }
            .interpretation-text.high, .interpretation-text.normal, .interpretation-text.excellent {
                color: var(--success-color);
                font-weight: bold; /* Highlight success/normal */
            }


         #chart-container {
            margin-top: 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            height: 500px; /* Fixed height for the chart */
            display: none; /* Hide by default, only show for PERMA results */
         }

        .unanswered-message {
            color: var(--danger-color);
            font-weight: bold;
            margin-top: 15px;
        }
         .completion-message {
             color: var(--primary-color);
             margin-top: 15px;
         }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            .tab-button {
                margin-bottom: 5px;
                border-bottom: 1px solid var(--tab-inactive-color);
            }
             .tab-button.active {
                 border-bottom-color: var(--primary-color);
             }
        }

         @media (max-width: 600px) {
            .option {
                font-size: 9px; /* Further reduce font size */
                margin: 0 1px; /* Reduce margin */
                padding: 5px 0;
            }
             .label {
                 font-size: 0.7em;
                 bottom: 3px; /* Move labels up slightly */
                 left: 10px;
                 right: 10px;
                 width: calc(100% - 20px);
             }
             .question {
                 padding-bottom: 25px; /* Adjust padding for smaller labels */
             }
             .tab-button {
                 font-size: 0.9em;
                 padding: 8px 10px;
             }
        }
            #perma-chart-container {
                margin-top: 20px;
                background-color: white;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 15px;
                height: 500px; /* Fixed height for the PERMA chart container */
                width: 100%; /* Full width */
                box-sizing: border-box;
                display: none; /* Hide by default */
            }
            #perma-chart-container canvas {
                width: 100% !important;
                height: 90% !important;
            }
        </style>
</head>
<body>
    <h1>C√¥ng c·ª• ƒê√°nh gi√° S·ª©c kh·ªèe Tinh th·∫ßn</h1>
    <p>C√¥ng c·ª• n√†y gi√∫p b·∫°n t·ª± ƒë√°nh gi√° m·ªôt s·ªë kh√≠a c·∫°nh v·ªÅ s·ª©c kh·ªèe tinh th·∫ßn v√† h·∫°nh ph√∫c d·ª±a tr√™n c√°c thang ƒëo PERMA, GHQ-12 v√† DASS-21.</p>

    <div>
        <label for="name">H·ªç t√™n:</label>
        <input type="text" id="name" placeholder="Nh·∫≠p h·ªç t√™n c·ªßa b·∫°n">
    </div>
    <div>
        <label for="date">Ng√†y l√†m test:</label>
        <input type="date" id="date">
    </div>

    <div class="tabs">
        <button class="tab-button active" onclick="openTab(event, 'perma')">PERMA Profiler</button>
        <button class="tab-button" onclick="openTab(event, 'ghq12')">GHQ-12</button>
        <button class="tab-button" onclick="openTab(event, 'dass21')">DASS-21</button>
        <button class="tab-button" onclick="openTab(event, 'results')">K·∫øt qu·∫£</button>
    </div>

    <div id="perma" class="tab-content active">
        <h2>PERMA Profiler</h2>
         <p>ƒê√°nh gi√° s·ª©c kh·ªèe tinh th·∫ßn v√† h·∫°nh ph√∫c d·ª±a tr√™n l√Ω thuy·∫øt PERMA c·ªßa Martin Seligma.</p>
         <div class="legend">
             <h3>H√£y tr·∫£ l·ªùi 15 c√¢u h·ªèi d·ª±a tr√™n c·∫£m nh·∫≠n c·ªßa b·∫°n tr√™n thang ƒëi·ªÉm t·ª´ 0 (th·∫•p nh·∫•t) ƒë·∫øn 10 (cao nh·∫•t):</h3>
              <p>V√≠ d·ª•: N·∫øu c√¢u h·ªèi h·ªèi v·ªÅ m·ª©c ƒë·ªô vui v·∫ª v√† b·∫°n c·∫£m th·∫•y m√¨nh r·∫•t vui v·∫ª, h√£y ch·ªçn ƒëi·ªÉm 9 ho·∫∑c 10. N·∫øu b·∫°n c·∫£m th·∫•y kh√¥ng vui v·∫ª ch√∫t n√†o, h√£y ch·ªçn ƒëi·ªÉm 0.</p>
         </div>
        <div id="perma-questions"></div>
    </div>

    <div id="ghq12" class="tab-content">
        <h2>GHQ-12 (General Health Questionnaire)</h2>
         <p>ƒê√°nh gi√° c√°c v·∫•n ƒë·ªÅ s·ª©c kh·ªèe t√¢m th·∫ßn ph·ªï bi·∫øn trong 4 tu·∫ßn g·∫ßn ƒë√¢y.</p>
         <div class="legend">
             <h3>Vui l√≤ng cho bi·∫øt b·∫°n c√≥ g·∫∑p c√°c v·∫•n ƒë·ªÅ sau ƒë√¢y trong kho·∫£ng 4 tu·∫ßn tr·ªü l·∫°i ƒë√¢y KH√îNG?</h3>
             <p>Thang ƒëi·ªÉm: 0 = Ho√†n to√†n kh√¥ng, 1 = √çt h∆°n th∆∞·ªùng l·ªá, 2 = Gi·ªëng nh∆∞ th∆∞·ªùng l·ªá, 3 = Nhi·ªÅu h∆°n th∆∞·ªùng l·ªá</p>
         </div>
        <div id="ghq12-questions"></div>
    </div>

    <div id="dass21" class="tab-content">
        <h2>DASS-21 (Depression, Anxiety, Stress Scale)</h2>
         <p>ƒê√°nh gi√° m·ª©c ƒë·ªô c·ªßa c√°c tri·ªáu ch·ª©ng Tr·∫ßm c·∫£m, Lo √¢u v√† Stress trong tu·∫ßn qua.</p>
         <div class="legend">
             <h3>Vui l√≤ng ƒë·ªçc k·ªπ t·ª´ng m·ª•c sau v√† ch·ªçn s·ªë ph√π h·ª£p nh·∫•t cho th·∫•y b·∫°n ƒë√£ tr·∫£i qua t√¨nh tr·∫°ng ƒë√≥ trong TU·∫¶N QUA.</h3>
             <p>Thang ƒëi·ªÉm: 0 = Kh√¥ng ƒë√∫ng v·ªõi t√¥i ch√∫t n√†o, 1 = ƒê√∫ng v·ªõi t√¥i 1 ph·∫ßn, hay th·ªânh tho·∫£ng m·ªõi ƒë√∫ng, 2 = ƒê√∫ng v·ªõi t√¥i ph·∫ßn l·ªõn th·ªùi gian, hay ph·∫ßn l·ªõn l√† ƒë√∫ng, 3 = Ho√†n to√†n ƒë√∫ng v·ªõi t√¥i, hay ƒë√∫ng h·∫ßu h·∫øt th·ªùi gian</p>
         </div>
        <div id="dass21-questions"></div>
    </div>

    <div id="results" class="tab-content">
        <h2>K·∫øt qu·∫£ ƒê√°nh gi√°</h2>
         <p id="results-intro">Xem l·∫°i k·∫øt qu·∫£ c·ªßa c√°c b√†i ƒë√°nh gi√° ƒë√£ ho√†n th√†nh.</p>
        <div id="results-content">
            <p class="completion-message">Vui l√≤ng ho√†n th√†nh c√°c b√†i test ·ªü c√°c tab tr∆∞·ªõc ƒë·ªÉ xem k·∫øt qu·∫£.</p>
             </div>
         <button class="clear-data-button" onclick="clearData()">X√≥a t·∫•t c·∫£ d·ªØ li·ªáu ƒë√£ l∆∞u</button>
         <div id="perma-chart-container" style="display: bla;">
             <h3>Bi·ªÉu ƒë·ªì PERMA</h3>
             <canvas id="perma-chart"></canvas>
         </div>

         <p></p>
         <p> T√≠n ƒë·∫πp trai üòä</p>
         <button onclick="window.location.href='https://fb.com/trungtin0105';">
             N·∫øu b·∫°n c·∫ßn t√¨m hi·ªÉu th√™m ho·∫∑c c·∫ßn h·ªó tr·ª£, üëâ h√£y nh·∫•n v√†o ƒë√¢y nghen!
         </button>
          <p></p>

    </div>

    <script>
        // --- Question Data ---
        const permaQuestions = [
            /*1 A*/ "B·∫°n c√≥ th∆∞·ªùng xuy√™n c·∫£m th·∫•y m√¨nh ƒëang ti·∫øn g·∫ßn h∆°n t·ªõi c√°c m·ª•c ti√™u c·ªßa m√¨nh?",
            /*2 E*/ "B·∫°n c√≥ th∆∞·ªùng xuy√™n b·ªã cu·ªën h√∫t ho·∫∑c ch√¨m ƒë·∫Øm v√†o nh·ªØng vi·ªác m√¨nh ƒëang l√†m?",
            /*3 P*/ "Nh√¨n chung, b·∫°n c√≥ th∆∞·ªùng xuy√™n c·∫£m th·∫•y vui v·∫ª kh√¥ng?",
            /*4 A*/ "B·∫°n c√≥ th∆∞·ªùng xuy√™n ƒë·∫°t ƒë∆∞·ª£c c√°c m·ª•c ti√™u quan tr·ªçng m√† b·∫°n t·ª± ƒë·∫∑t ra cho m√¨nh?",
            /*5 M*/ "Nh√¨n chung, b·∫°n c√≥ s·ªëng m·ªôt cu·ªôc s·ªëng c√≥ √Ω nghƒ©a v√† m·ª•c ƒë√≠ch kh√¥ng? (N·∫øu c√≥ th√¨ ·ªü m·ª©c ƒë·ªô n√†o?)",
            /*6 R*/ "Khi b·∫°n c·∫ßn, b·∫°n c√≥ th∆∞·ªùng nh·∫≠n ƒë∆∞·ª£c s·ª± h·ªó tr·ª£ v√† gi√∫p ƒë·ª° c·ªßa ng∆∞·ªùi kh√°c kh√¥ng?",
            /*7 M*/ "Nh√¨n chung, b·∫°n c√≥ c·∫£m th·∫•y nh·ªØng g√¨ m√¨nh l√†m trong cu·ªôc ƒë·ªùi m√¨nh l√† c√≥ gi√° tr·ªã v√† x·ª©ng ƒë√°ng kh√¥ng? (N·∫øu c√≥ th√¨ ·ªü m·ª©c ƒë·ªô n√†o?)",
            /*8 E*/ "Nh√¨n chung, b·∫°n c√≥ c·∫£m th·∫•y ph·∫•n kh√≠ch v√† th√≠ch th√∫ v·ªõi nh·ªØng ƒëi·ªÅu xung quanh? (N·∫øu c√≥ th√¨ ·ªü m·ª©c ƒë·ªô n√†o?)",
            /*9 P*/ "Nh√¨n chung, b·∫°n c√≥ th∆∞·ªùng xuy√™n c·∫£m th·∫•y t√≠ch c·ª±c kh√¥ng?",
            /*10 A*/ "B·∫°n c√≥ th∆∞·ªùng xuy√™n c√≥ th·ªÉ x·ª≠ l√Ω h·∫øt c√°c tr√°ch nhi·ªám c·ªßa m√¨nh (c·∫£ trong c√¥ng vi·ªác v√† ·ªü gia ƒë√¨nh) kh√¥ng?",
            /*11 E*/ "B·∫°n c√≥ th∆∞·ªùng xuy√™n c√≥ tr·∫£i nghi·ªám l√†m g√¨ ƒë√≥ m√¨nh th√≠ch v√† qu√™n kh√¥ng ƒë·ªÉ √Ω bao nhi√™u th·ªùi gian ƒë√£ tr√¥i qua?",
            /*12 R*/ "B·∫°n c√≥ c·∫£m th·∫•y m√¨nh ƒëang ƒë∆∞·ª£c y√™u th∆∞∆°ng kh√¥ng? (N·∫øu c√≥ th√¨ ·ªü m·ª©c ƒë·ªô n√†o?)",
            /*13 M*/ "B·∫°n c·∫£m th·∫•y m√¨nh c√≥ ƒë·ªãnh h∆∞·ªõng trong cu·ªôc s·ªëng ƒë·∫øn m·ª©c n√†o?",
            /*14 R*/ "B·∫°n h√†i l√≤ng v·ªõi c√°c m·ªëi quan h·ªá c√° nh√¢n c·ªßa m√¨nh ƒë·∫øn m·ª©c n√†o?",
            /*15 P/Happiness*/ "Nh√¨n chung, b·∫°n h√†i l√≤ng ho·∫∑c m√£n nguy·ªán ho·∫∑c v·ªõi cu·ªôc s·ªëng c·ªßa m√¨nhh ƒë·∫øn m·ª©c n√†o?",
        ];
         const permaLabelsLeft = [ "Kh√¥ng bao gi·ªù", "Kh√¥ng bao gi·ªù", "Kh√¥ng bao gi·ªù", "Kh√¥ng bao gi·ªù", "Ho√†n to√†n kh√¥ng", "Kh√¥ng bao gi·ªù", "Ho√†n to√†n kh√¥ng", "Ho√†n to√†n kh√¥ng", "Kh√¥ng bao gi·ªù", "Kh√¥ng bao gi·ªù", "Kh√¥ng bao gi·ªù", "Ho√†n to√†n kh√¥ng", "Ho√†n to√†n kh√¥ng", "Ho√†n to√†n kh√¥ng", "Ho√†n to√†n kh√¥ng", ];
         const permaLabelsRight = [ "Lu√¥n lu√¥n", "Lu√¥n lu√¥n", "Lu√¥n lu√¥n", "Lu√¥n lu√¥n", "Ho√†n to√†n c√≥", "Lu√¥n lu√¥n", "Ho√†n to√†n c√≥", "Ho√†n to√†n c√≥", "Lu√¥n lu√¥n", "Lu√¥n lu√¥n", "Lu√¥n lu√¥n", "Ho√†n to√†n c√≥", "Ho√†n to√†n c√≥", "Ho√†n to√†n h√†i l√≤ng", "Ho√†n to√†n h√†i l√≤ng", ];
         const permaMapping = { // Mapping questions (0-indexed) to PERMA dimensions (based on your original code)
             P: [2, 8, 14], // Q3, Q9, Q15
             E: [1, 7, 10], // Q2, Q8, Q11
             R: [5, 11, 13], // Q6, Q12, Q14
             M: [4, 6, 12], // Q5, Q7, Q13
             A: [0, 3, 9], // Q1, Q4, Q10
         };

        const ghq12Questions = [
            "B·∫°n c√≥ c·∫£m th·∫•y lu√¥n kho·∫ª m·∫°nh kh√¥ng?", // Ng∆∞·ª£c
            "B·∫°n c√≥ c·∫£m th·∫•y c·∫ßn th√™m ch√∫t thu·ªëc ng·ªß kh√¥ng?",
            "B·∫°n c√≥ c·∫£m th·∫•y lu√¥n b·ªã cƒÉng th·∫≥ng kh√¥ng?",
            "B·∫°n c√≥ c·∫£m th·∫•y kh√¥ng th·ªÉ v∆∞·ª£t qua nh·ªØng kh√≥ khƒÉn c·ªßa m√¨nh kh√¥ng?",
            "B·∫°n c√≥ c·∫£m th·∫•y kh√¥ng th·ªÉ t·∫≠p trung ƒë∆∞·ª£c khi l√†m vi·ªác kh√¥ng?",
            "B·∫°n c√≥ c·∫£m th·∫•y hay qu√™n h∆°n th∆∞·ªùng l·ªá kh√¥ng?",
            "B·∫°n c√≥ c·∫£m th·∫•y cu·ªôc s·ªëng h√†ng ng√†y th·∫≠t v√¥ √≠ch kh√¥ng?", // Ng∆∞·ª£c
            "B·∫°n c√≥ c·∫£m th·∫•y m√¨nh kh√¥ng c√≥ kh·∫£ nƒÉng quy·∫øt ƒë·ªãnh m·ªçi vi·ªác kh√¥ng?",
            "B·∫°n c√≥ c·∫£m th·∫•y m√¨nh kh√¥ng ƒë∆∞·ª£c h∆∞·ªüng nh·ªØng ho·∫°t ƒë·ªông th∆∞·ªùng ng√†y c·ªßa b·∫°n kh√¥ng?", // Ng∆∞·ª£c
            "B·∫°n c√≥ c·∫£m th·∫•y m√¨nh kh√¥ng c√≥ kh·∫£ nƒÉng ƒë·ªëi di·ªán v·ªõi c√°c kh√≥ khƒÉn c·ªßa m√¨nh kh√¥ng?",
            "B·∫°n c√≥ c·∫£m th·∫•y hay lo l·∫Øng v√† kh√≥ ng·ªß kh√¥ng?",
            "B·∫°n c√≥ c·∫£m th·∫•y lu√¥n c√≥ th·ªÉ l√†m m·ªçi vi·ªác hi·ªáu qu·∫£ kh√¥ng?", // Ng∆∞·ª£c
        ];
         const ghq12Labels = ["Ho√†n to√†n kh√¥ng", "√çt h∆°n th∆∞·ªùng l·ªá", "Gi·ªëng nh∆∞ th∆∞·ªùng l·ªá", "Nhi·ªÅu h∆°n th∆∞·ªùng l·ªá"];
         const ghq12ReverseScored = [0, 6, 8, 11]; // Indices of questions that are reverse scored (0-indexed)

        const dass21Questions = [
             "T√¥i th·∫•y m√¨nh kh√≥ m√† b√¨nh tƒ©nh l·∫°i ƒë∆∞·ª£c", // S1
             "T√¥i th·∫•y kh√¥ mi·ªáng", // A1
             "T√¥i kh√¥ng c√≤n c·∫£m th·∫•y t√≠ch c·ª±c n√†o c·∫£", // D1
             "T√¥i c·∫£m th·∫•y kh√≥ th·ªü (v√≠ d·ª•: th·ªü g·∫•p, h·ª•t h∆°i d√π kh√¥ng g·∫Øng s·ª©c)", // A2
             "T√¥i th·∫•y m√¨nh kh√≥ m√† b·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªông ƒë∆∞·ª£c", // D2
             "T√¥i c√≥ xu h∆∞·ªõng ph·∫£n ·ª©ng th√°i qu√° tr∆∞·ªõc nh·ªØng t√¨nh hu·ªëng kh√≥ khƒÉn", // S2
             "T√¥i th·∫•y m√¨nh run r·∫©y", // A3
             "T√¥i th·∫•y m√¨nh ti√™u hao r·∫•t nhi·ªÅu nƒÉng l∆∞·ª£ng lo l·∫Øng", // S3
             "T√¥i th·∫•y bu·ªìn v√† ch√°n n·∫£n", // D3
             "T√¥i bi·∫øt m√¨nh s·∫Ω lo √¢u", // A4
             "T√¥i kh√¥ng th·∫•y h·ª©ng th√∫ v·ªõi b·∫•t c·ª© ƒëi·ªÅu g√¨", // D4
             "T√¥i th·∫•y m√¨nh b·ªìn ch·ªìn kh√¥ng y√™n", // S4
             "T√¥i th·∫•y kh√≥ th∆∞ gi√£n", // A5
             "T√¥i th·∫•y m√¨nh ch√°n n·∫£n v√† v√¥ v·ªçng", // D5
             "T√¥i lo l·∫Øng d·ªÖ d√†ng", // A6
             "T√¥i th·∫•y m√¨nh kh√¥ng x·ª©ng ƒë√°ng g√¨ c·∫£", // D6
             "T√¥i c·∫£m th·∫•y d·ªÖ b·ªã x√∫c ph·∫°m", // S5
             "T√¥i th·∫•y m√¨nh g·∫ßn nh∆∞ ho·∫£ng lo·∫°n", // A7
             "T√¥i th·∫•y m√¨nh kh√¥ng c√≤n y√™u th√≠ch b·∫•t c·ª© ƒëi·ªÅu g√¨", // D7
             "T√¥i th·∫•y h∆°i lo l·∫Øng khi ph·∫£i ƒë·ªëi m·∫∑t v·ªõi m·ªôt t√¨nh hu·ªëng c√≥ th·ªÉ l√†m m√¨nh ho·∫£ng lo·∫°n", // S6
             "T√¥i th·∫•y h∆°i ƒë·ªï m·ªì h√¥i (v√≠ d·ª•: m·ªì h√¥i tay) m·∫∑c d√π tr·ªùi kh√¥ng n√≥ng b·ª©c", // S7
        ];
         // Mapping questions (0-indexed) to DASS-21 dimensions
         const dass21Mapping = {
             'Tr·∫ßm c·∫£m': [2, 4, 8, 10, 13, 15, 18], // D1-D7
             'Lo √¢u': [1, 3, 6, 9, 12, 14, 17], // A1-A7
             'Stress': [0, 5, 7, 11, 16, 19, 20], // S1-S7
         };
         const dass21Labels = ["Kh√¥ng ƒë√∫ng v·ªõi t√¥i ch√∫t n√†o", "ƒê√∫ng v·ªõi t√¥i 1 ph·∫ßn, hay th·ªânh tho·∫£ng m·ªõi ƒë√∫ng", "ƒê√∫ng v·ªõi t√¥i ph·∫ßn l·ªõn th·ªùi gian, hay ph·∫ßn l·ªõn l√† ƒë√∫ng", "Ho√†n to√†n ƒë√∫ng v·ªõi t√¥i, hay ƒë√∫ng h·∫ßu h·∫øt th·ªùi gian"];


        // --- Interpretation Data (from Manual) ---

        // PERMA Interpretation
        const permaDimensionInterpretations = {
             P: { low: "C·∫£m x√∫c t√≠ch c·ª±c th·∫•p c√≥ th·ªÉ li√™n quan tr·∫ßm c·∫£m ho·∫∑c stress cao. Khuy·∫øn ngh·ªã t·∫≠p trung c·∫£i thi·ªán tr·∫°ng th√°i c·∫£m x√∫c t√≠ch c·ª±c qua can thi·ªáp t√¢m l√Ω.", medium: "M·ª©c ƒë·ªô c·∫£m x√∫c t√≠ch c·ª±c trung b√¨nh.", high: "M·ª©c ƒë·ªô c·∫£m x√∫c t√≠ch c·ª±c cao." },
             E: { low: "Tham gia th·∫•p bi·ªÉu hi·ªán thi·∫øu ƒë·ªông l·ª±c ho·∫∑c kh√≥ t·∫≠p trung. Khuy·∫øn kh√≠ch ph√°t tri·ªÉn k·ªπ nƒÉng t·∫≠p trung, t√¨m ho·∫°t ƒë·ªông ph√π h·ª£p.", medium: "M·ª©c ƒë·ªô g·∫Øn k·∫øt trung b√¨nh.", high: "M·ª©c ƒë·ªô g·∫Øn k·∫øt cao." },
             R: { low: "M·ªëi quan h·ªá x√£ h·ªôi y·∫øu c√≥ th·ªÉ t·∫°o c·∫£m nh·∫≠n b·ªã c√¥ l·∫≠p v√† suy gi·∫£m s·ª©c kh·ªèe tinh th·∫ßn. Khuy·∫øn ngh·ªã tƒÉng c∆∞·ªùng k·∫øt n·ªëi x√£ h·ªôi, nh√≥m h·ªó tr·ª£.", medium: "M·ª©c ƒë·ªô m·ªëi quan h·ªá trung b√¨nh.", high: "M·ª©c ƒë·ªô m·ªëi quan h·ªá cao." },
             M: { low: "Thi·∫øu √Ω nghƒ©a s·ªëng g√¢y c·∫£m gi√°c m·∫•t ph∆∞∆°ng h∆∞·ªõng. Khuy·∫øn kh√≠ch kh√°m ph√° gi√° tr·ªã c√° nh√¢n v√† m·ª•c ƒë√≠ch s·ªëng.", medium: "M·ª©c ƒë·ªô √Ω nghƒ©a s·ªëng trung b√¨nh.", high: "M·ª©c ƒë·ªô √Ω nghƒ©a s·ªëng cao." },
             A: { low: "Th√†nh t·ª±u th·∫•p c√≥ th·ªÉ g√¢y c·∫£m gi√°c b·∫•t l·ª±c ho·∫∑c thi·∫øu ki·ªÉm so√°t. H·ªó tr·ª£ thi·∫øt l·∫≠p m·ª•c ti√™u th·ª±c t·∫ø v√† ph√°t tri·ªÉn k·ªπ nƒÉng qu·∫£n l√Ω.", medium: "M·ª©c ƒë·ªô c·∫£m nh·∫≠n th√†nh t·ª±u trung b√¨nh.", high: "M·ª©c ƒë·ªô c·∫£m nh·∫≠n th√†nh t·ª±u cao." },
             // Manual also lists Negative Emotions, Health, Loneliness but without scoring from provided questions
             'C·∫£m x√∫c ti√™u c·ª±c': { low: "M·ª©c ƒë·ªô c·∫£m x√∫c ti√™u c·ª±c th·∫•p.", medium: "M·ª©c ƒë·ªô c·∫£m x√∫c ti√™u c·ª±c trung b√¨nh.", high: "ƒêi·ªÉm cao ph·∫£n √°nh c·∫£m x√∫c ti√™u c·ª±c th∆∞·ªùng xuy√™n (lo √¢u, bu·ªìn b√£, t·ª©c gi·∫≠n). C·∫ßn ch√∫ √Ω can thi·ªáp gi·∫£m stress v√† tr·ªã li·ªáu t√¢m l√Ω n·∫øu c·∫ßn." },
             'S·ª©c kh·ªèe': { low: "S·ª©c kh·ªèe ƒë∆∞·ª£c ƒë√°nh gi√° l√† k√©m, ·∫£nh h∆∞·ªüng t·ªïng th·ªÉ ƒë·∫øn c·∫£m nh·∫≠n h·∫°nh ph√∫c. Khuy·∫øn kh√≠ch chƒÉm s√≥c s·ª©c kh·ªèe th·ªÉ ch·∫•t.", medium: "S·ª©c kh·ªèe ·ªü m·ª©c trung b√¨nh.", high: "S·ª©c kh·ªèe ƒë∆∞·ª£c ƒë√°nh gi√° l√† t·ªët." },
             'C√¥ ƒë∆°n': { low: "M·ª©c ƒë·ªô c√¥ ƒë∆°n th·∫•p.", medium: "M·ª©c ƒë·ªô c√¥ ƒë∆°n trung b√¨nh.", high: "ƒêi·ªÉm cao bi·ªÉu hi·ªán c·∫£m gi√°c c√¥ ƒë∆°n nhi·ªÅu. Khuy·∫øn ngh·ªã tƒÉng c∆∞·ªùng h·ªó tr·ª£ x√£ h·ªôi v√† ho·∫°t ƒë·ªông c·ªông ƒë·ªìng." }
        };
         const permaTotalInterpretations = {
             excellent: "M·ª©c ƒë·ªô h·∫°nh ph√∫c tuy·ªát v·ªùi. Ti·∫øp t·ª•c duy tr√¨ v√† ph√°t tri·ªÉn c√°c kh√≠a c·∫°nh n√†y!", // 9.0 - 10.0
             high: "H·∫°nh ph√∫c ·ªü m·ª©c trung b√¨nh cao. B·∫°n ƒëang c√≥ n·ªÅn t·∫£ng t·ªët v·ªÅ s·ª©c kh·ªèe tinh th·∫ßn.", // 7.0 - 8.9
             medium: "C√≥ th·ªÉ c·∫£i thi·ªán th√™m ƒë·ªÉ n√¢ng m·ª©c ƒë·ªô h·∫°nh ph√∫c. H√£y xem x√©t c√°c lƒ©nh v·ª±c c√≥ ƒëi·ªÉm th·∫•p ƒë·ªÉ t·∫≠p trung ph√°t tri·ªÉn.", // 5.0 - 6.9
             risk: "C√≥ nguy c∆° g·∫∑p r·ªëi lo·∫°n s·ª©c kh·ªèe tinh th·∫ßn. H√£y c√¢n nh·∫Øc t√¨m ki·∫øm s·ª± h·ªó tr·ª£ t·ª´ chuy√™n gia t√¢m l√Ω ƒë·ªÉ c·∫£i thi·ªán m·ª©c ƒë·ªô h·∫°nh ph√∫c v√† s·ª©c kh·ªèe tinh th·∫ßn t·ªïng th·ªÉ.", // < 5.0
         };

         // DASS-21 Interpretation (from Manual)
         const dass21InterpretationRanges = {
             'Tr·∫ßm c·∫£m': [{ max: 4, level: 'B√¨nh th∆∞·ªùng' }, { max: 6, level: 'Nh·∫π' }, { max: 10, level: 'V·ª´a' }, { max: 13, level: 'N·∫∑ng' }, { max: Infinity, level: 'R·∫•t n·∫∑ng' }],
             'Lo √¢u': [{ max: 3, level: 'B√¨nh th∆∞·ªùng' }, { max: 5, level: 'Nh·∫π' }, { max: 7, level: 'V·ª´a' }, { max: 9, level: 'N·∫∑ng' }, { max: Infinity, level: 'R·∫•t n·∫∑ng' }],
             'Stress': [{ max: 7, level: 'B√¨nh th∆∞·ªùng' }, { max: 9, level: 'Nh·∫π' }, { max: 12, level: 'V·ª´a' }, { max: 16, level: 'N·∫∑ng' }, { max: Infinity, level: 'R·∫•t n·∫∑ng' }],
         };
         const dass21InterpretationText = {
              'B√¨nh th∆∞·ªùng': "Kh√¥ng c√≥ v·∫•n ƒë·ªÅ ƒë√°ng k·ªÉ ·ªü m·ª©c ƒë·ªô n√†y.",
              'Nh·∫π': "C√≥ bi·ªÉu hi·ªán nh·∫π. Khuy·∫øn ngh·ªã tƒÉng c∆∞·ªùng ho·∫°t ƒë·ªông th·ªÉ ch·∫•t, chƒÉm s√≥c b·∫£n th√¢n, c√°c ho·∫°t ƒë·ªông k·∫øt n·ªëi x√£ h·ªôi.",
              'V·ª´a': "C√≥ bi·ªÉu hi·ªán v·ª´a. Khuy·∫øn ngh·ªã t√¨m ki·∫øm s·ª± gi√∫p ƒë·ª° t·ª´ b√°c sƒ© t√¢m th·∫ßn v√† nh√† t√¢m l√Ω ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£, tr·ªã li·ªáu h·ª£p l√Ω (ƒë·ªëi v·ªõi Tr·∫ßm c·∫£m, Lo √¢u). Khuy·∫øn ngh·ªã t√¨m g·∫∑p nh√† t√¢m l√Ω nh·∫±m th√°o g·ª° kh√∫c m·∫Øc t√¢m l√Ω v√† c√≥ nh·ªØng c√°ch ·ª©ng ph√≥ stress hi·ªáu qu·∫£ h∆°n (ƒë·ªëi v·ªõi Stress).",
              'N·∫∑ng': "C√≥ bi·ªÉu hi·ªán n·∫∑ng. Khuy·∫øn ngh·ªã t√¨m ki·∫øm s·ª± gi√∫p ƒë·ª° t·ª´ b√°c sƒ© t√¢m th·∫ßn v√† nh√† t√¢m l√Ω ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£, tr·ªã li·ªáu h·ª£p l√Ω.",
              'R·∫•t n·∫∑ng': "C√≥ bi·ªÉu hi·ªán r·∫•t n·∫∑ng. Khuy·∫øn ngh·ªã t√¨m ki·∫øm s·ª± gi√∫p ƒë·ª° t·ª´ b√°c sƒ© t√¢m th·∫ßn v√† nh√† t√¢m l√Ω ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£, tr·ªã li·ªáu h·ª£p l√Ω kh·∫©n c·∫•p."
         };


         // GHQ-12 Interpretation (from Manual)
         const ghq12Interpretation = {
             threshold1: { score: 15, text: "ƒêi·ªÉm tr√™n 15 g·ª£i √Ω b·∫±ng ch·ª©ng c√≥ v·∫•n ƒë·ªÅ t√¢m l√Ω v√† th·ªÉ ch·∫•t. Khuy·∫øn ngh·ªã thƒÉm kh√°m t·ªïng quan v·ªÅ c·∫£ s·ª©c kh·ªèe th·ªÉ ch·∫•t l·∫´n tinh th·∫ßn v√† t√¨m ki·∫øm s·ª± h·ªó tr·ª£ k·ªãp th·ªùi." },
             threshold2: { score: 20, text: "ƒêi·ªÉm tr√™n 20 g·ª£i √Ω c√°c v·∫•n ƒë·ªÅ s·ª©c kh·ªèe nghi√™m tr·ªçng v√† t·ªïn th∆∞∆°ng t√¢m l√Ω. Khuy·∫øn ngh·ªã thƒÉm kh√°m t·ªïng quan v·ªÅ c·∫£ s·ª©c kh·ªèe th·ªÉ ch·∫•t l·∫´n tinh th·∫ßn v√† t√¨m ki·∫øm s·ª± h·ªó tr·ª£ k·ªãp k·ªãp th·ªùi t·ª´ c√°c b√°c sƒ©, nh√† t√¢m l√Ω." },
         };


        // --- Global Variables ---
        let permaChart = null; // To hold the Chart.js instance for PERMA
        let allResults = {}; // To store results from all tests

        // --- Tab Management ---
        function openTab(evt, tabName) {
            let tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            let tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');

            // If switching to results tab, display results
            if (tabName === 'results') {
                displayAllResults();
            } else {
                 // Hide PERMA chart when switching away from results
                 document.getElementById('perma-chart-container').style.display = 'none';
            }
        }

        // --- Question Rendering ---
        function renderQuestions(containerId, questions, labels, scaleType = '0-10', reverseScored = []) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear previous questions

            const optionsHtml = (scaleType) => {
                let html = '';
                let values = [];
                let valueLabels = [];

                if (scaleType === '0-10') {
                    values = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
                } else if (scaleType === '0-3') {
                    values = [0, 1, 2, 3];
                }

                html = values.map(value => `<div class="option" data-value="${value}">${value}</div>`).join('');
                return html;
            };

             const labelHtml = (scaleType, index, labels) => {
                 if (scaleType === '0-10') {
                     return `<div class="label scale-${scaleType}"><span class="left">${labels[index*2]}</span><span class="right">${labels[index*2 + 1]}</span></div>`;
                 } else if (scaleType === '0-3') {
                     return `<div class="label scale-${scaleType}"><span>${labels[0]}</span><span>${labels[1]}</span><span>${labels[2]}</span><span>${labels[3]}</span></div>`;
                 }
                 return ''; // No labels for other types
             };


            questions.forEach((q, index) => {
                container.innerHTML += `
                    <div class="question" data-question-index="${index}" data-scale-type="${scaleType}" ${reverseScored.includes(index) ? 'data-reverse-scored="true"' : ''}>
                        <p><strong>${index + 1}.</strong> ${q}</p>
                        <div class="options">
                            ${optionsHtml(scaleType)}
                        </div>
                        ${labelHtml(scaleType, index, labels)}
                    </div>
                `;
            });

            // Add click listeners to options
            container.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    const optionsContainer = this.parentElement;
                    const questionElement = optionsContainer.parentElement;
                    const questionIndex = parseInt(questionElement.getAttribute('data-question-index'));
                    const value = parseInt(this.getAttribute('data-value'));
                    const scale = questionElement.getAttribute('data-scale-type');
                     const containerId = questionElement.parentElement.id; // e.g., perma-questions

                    selectOption(containerId, questionIndex, value, scale);
                });
            });
        }

        function selectOption(containerId, questionIndex, value, scaleType) {
            const container = document.getElementById(containerId);
            const questionElement = container.querySelector(`.question[data-question-index="${questionIndex}"]`);
            const options = questionElement.querySelectorAll('.option');

            options.forEach(option => option.classList.remove('selected'));
            questionElement.querySelector(`.option[data-value="${value}"]`).classList.add('selected');

             // Store selected value directly on the question element
             questionElement.setAttribute('data-selected-value', value);
        }

        function getSelectedScore(containerId, questionIndex) {
             const container = document.getElementById(containerId);
             const questionElement = container.querySelector(`.question[data-question-index="${questionIndex}"]`);
             const selectedValue = questionElement ? questionElement.getAttribute('data-selected-value') : null;
             return selectedValue !== null ? parseInt(selectedValue) : null; // Return null if not selected
        }

        // --- Scoring Logic ---

        function calculateAllScores() {
            const resultsContentDiv = document.getElementById('results-content');
             resultsContentDiv.innerHTML = ''; // Clear previous results

            const name = document.getElementById('name').value || 'Ng∆∞·ªùi d√πng';
            const date = document.getElementById('date').value || new Date().toLocaleDateString();

            allResults = {
                 name: name,
                 date: date,
                 perma: null,
                 ghq12: null,
                 dass21: null,
            };

             // Calculate PERMA
            const permaScores = calculatePERMAScores();
            if (permaScores) {
                 allResults.perma = permaScores;
            } else {
                 resultsContentDiv.innerHTML += '<p class="unanswered-message">Vui l√≤ng ho√†n th√†nh b√†i test PERMA Profiler.</p>';
            }

             // Calculate GHQ-12
             const ghq12Scores = calculateGHQ12Scores();
             if (ghq12Scores !== null) { // GHQ-12 calculates total, 0 is a valid score
                  allResults.ghq12 = ghq12Scores;
             } else {
                  resultsContentDiv.innerHTML += '<p class="unanswered-message">Vui l√≤ng ho√†n th√†nh b√†i test GHQ-12.</p>';
             }

             // Calculate DASS-21
             const dass21Scores = calculateDASS21Scores();
              if (dass21Scores !== null) { // DASS-21 calculates subscales, 0 is valid
                  allResults.dass21 = dass21Scores;
              } else {
                  resultsContentDiv.innerHTML += '<p class="unanswered-message">Vui l√≤ng ho√†n th√†nh b√†i test DASS-21.</p>';
              }


             // Save results if at least one test is completed successfully
            if (allResults.perma || allResults.ghq12 || allResults.dass21) {
                 saveResults(allResults);
                 displayAllResults(allResults); // Pass results to display
            } else {
                 // If no tests completed, show message
                 resultsContentDiv.innerHTML = '<p class="unanswered-message">Vui l√≤ng ho√†n th√†nh √≠t nh·∫•t m·ªôt b√†i test ƒë·ªÉ xem k·∫øt qu·∫£.</p>';
            }


        }

        function calculatePERMAScores() {
             let unansweredCount = 0;
             const rawScores = {};

             for (let i = 0; i < permaQuestions.length; i++) {
                 const score = getSelectedScore('perma-questions', i);
                 if (score === null) {
                     unansweredCount++;
                     rawScores[i] = 0; // Use 0 for calculation if missing (after check)
                 } else {
                     rawScores[i] = score;
                 }
             }

             // Check for >20% missing data (more than 3 questions out of 15)
             if (unansweredCount > Math.floor(permaQuestions.length * 0.2)) {
                  // Handle this in calculateAllScores
                  return null; // Indicate incomplete
             }

             const dimensionScores = {}; // PERMA dimension averages
             for (const dimension in permaMapping) {
                 let sum = 0;
                 permaMapping[dimension].forEach(qIndex => {
                     sum += rawScores[qIndex];
                 });
                 dimensionScores[dimension] = sum / permaMapping[dimension].length;
             }

             // Assume Q15 (index 14) is the 'Happiness' score for total calculation
             let happinessScore = rawScores[14];

             // Calculate Total PERMA score using the manual's formula: (P + E + R + M + A + Happiness) / 6
              const totalPermaAverage = (dimensionScores.P + dimensionScores.E + dimensionScores.R + dimensionScores.M + dimensionScores.A + happinessScore) / 6;


             return {
                 dimensionScores: dimensionScores, // PERMA dimension averages
                 happinessScore: happinessScore, // Q15 score
                 totalPermaAverage: totalPermaAverage, // Total PERMA score / 6
             };
        }

        function calculateGHQ12Scores() {
             let totalScore = 0;
             let answeredCount = 0;

             for (let i = 0; i < ghq12Questions.length; i++) {
                 const score = getSelectedScore('ghq12-questions', i);
                 if (score !== null) {
                     answeredCount++;
                     // GHQ-12 standard scoring often converts 0,1,2,3 scale
                     // Manual implies summing the 0-3 scores directly to get 0-36 range
                     // Let's follow manual and sum 0-3 scores.
                     // Need to check for reverse scored items
                     const finalScore = ghq12ReverseScored.includes(i) ? (3 - score) : score;
                     totalScore += finalScore;
                 }
             }

             if (answeredCount < ghq12Questions.length) {
                  return null; // Indicate incomplete
             }

             return {
                 totalScore: totalScore,
             };
        }

        function calculateDASS21Scores() {
             const scores = {};
             let answeredCount = 0;

             for (const dimension in dass21Mapping) {
                 let sum = 0;
                 dass21Mapping[dimension].forEach(qIndex => {
                      const score = getSelectedScore('dass21-questions', qIndex);
                      if (score !== null) {
                          sum += score; // Sum raw 0-3 scores
                           answeredCount++;
                      }
                 });
                 scores[dimension] = sum;
             }

             if (answeredCount < dass21Questions.length) {
                 return null; // Indicate incomplete
             }


             return scores; // Returns { 'Tr·∫ßm c·∫£m': score, 'Lo √¢u': score, 'Stress': score }
        }

        // --- Display Results ---

        function displayAllResults(results = allResults) {
            const resultsContentDiv = document.getElementById('results-content');
            resultsContentDiv.innerHTML = ''; // Clear previous content

            // Check if results data is available
            if (!results || (!results.perma && !results.ghq12 && !results.dass21)) {
                const p = document.createElement('p');
                p.className = 'completion-message';
                p.textContent = 'Vui l√≤ng ho√†n th√†nh √≠t nh·∫•t m·ªôt b√†i test ƒë·ªÉ xem k·∫øt qu·∫£.';
                resultsContentDiv.appendChild(p);
                document.getElementById('perma-chart-container').style.display = 'none'; // Hide chart
                if (permaChart) {
                    permaChart.destroy();
                    permaChart = null;
                }
                return;
            }

            // Display name and date
            const nameP = document.createElement('p');
            const nameStrong = document.createElement('strong');
            nameStrong.textContent = 'H·ªç t√™n: ';
            nameP.appendChild(nameStrong);
            nameP.appendChild(document.createTextNode(results.name));
            resultsContentDiv.appendChild(nameP);

            const dateP = document.createElement('p');
            const dateStrong = document.createElement('strong');
            dateStrong.textContent = 'Ng√†y l√†m test: ';
            dateP.appendChild(dateStrong);
            dateP.appendChild(document.createTextNode(results.date));
            resultsContentDiv.appendChild(dateP);

            // Display PERMA Results
            if (results.perma) {
                const permaSection = document.createElement('div');
                permaSection.className = 'result-section';

                const permaTitle = document.createElement('h3');
                permaTitle.textContent = 'K·∫øt qu·∫£ PERMA Profiler';
                permaSection.appendChild(permaTitle);

                const dimensions = ['P', 'E', 'R', 'M', 'A'];
                const dimensionNames = {
                    P: 'C·∫£m x√∫c t√≠ch c·ª±c',
                    E: 'S·ª± g·∫Øn k·∫øt',
                    R: 'M·ªëi quan h·ªá',
                    M: '√ù nghƒ©a',
                    A: 'Th√†nh t·ª±u'
                };

                dimensions.forEach(dim => {
                    const p = document.createElement('p');
                    p.className = 'result-item';
                    p.innerHTML = `<span class="result-dimension">${dim} - ${dimensionNames[dim]}:</span> <span class="score">${results.perma.dimensionScores[dim].toFixed(2)}</span> ${getPERMADimensionInterpretation(results.perma.dimensionScores[dim], dim)}`;
                    permaSection.appendChild(p);
                });

                // Happiness score
                const happinessP = document.createElement('p');
                happinessP.className = 'result-item';
                const happinessScore = results.perma.happinessScore;
                const happinessClass = happinessScore >= 8 ? 'high' : (happinessScore >= 5 ? 'medium' : 'low');
                const happinessText = happinessScore >= 8 ? 'Cao' : (happinessScore >= 5 ? 'Trung b√¨nh' : 'Th·∫•p');
                happinessP.innerHTML = `<span class="result-dimension">H - H√†i l√≤ng cu·ªôc s·ªëng (C√¢u 15):</span> <span class="score">${happinessScore}</span> <span class="interpretation-text ${happinessClass}">ƒêi·ªÉm: ${happinessText}</span>`;
                permaSection.appendChild(happinessP);

                // Total PERMA score
                const totalP = document.createElement('p');
                totalP.className = 'result-item';
                const totalScore = results.perma.totalPermaAverage.toFixed(2);
                const totalClass = getPERMATotalInterpretationLevel(results.perma.totalPermaAverage);
                const totalText = getPERMATotalInterpretation(results.perma.totalPermaAverage);
                totalP.innerHTML = `<span class="result-dimension highlight">ƒêi·ªÉm PERMA t·ªïng h·ª£p:</span> <span class="score">${totalScore}</span> <span class="interpretation-text ${totalClass}">${totalText}</span>`;
                permaSection.appendChild(totalP);

                const noteP = document.createElement('p');
                noteP.className = 'result-item';
                noteP.innerHTML = `<em>L∆∞u √Ω: Manual c≈©ng c√≥ di·ªÖn gi·∫£i cho C·∫£m x√∫c ti√™u c·ª±c, S·ª©c kh·ªèe, C√¥ ƒë∆°n nh∆∞ng c√°c m·ª•c n√†y kh√¥ng n·∫±m trong c√¥ng th·ª©c t√≠nh ƒëi·ªÉm PERMA t·ªïng v√† c·∫ßn c√°c c√¢u h·ªèi ri√™ng ƒë·ªÉ ƒë√°nh gi√°.</em>`;
                permaSection.appendChild(noteP);

                resultsContentDiv.appendChild(permaSection);

                displayPERMAChart(results.perma.dimensionScores); // Show chart
            } else {
                document.getElementById('perma-chart-container').style.display = 'none'; // Hide chart if no results
                if (permaChart) {
                    permaChart.destroy();
                    permaChart = null;
                }
            }

            // Display GHQ-12 Results
            if (results.ghq12) {
                const ghqSection = document.createElement('div');
                ghqSection.className = 'result-section';

                const ghqTitle = document.createElement('h3');
                ghqTitle.textContent = 'K·∫øt qu·∫£ GHQ-12';
                ghqSection.appendChild(ghqTitle);

                const ghqP = document.createElement('p');
                ghqP.className = 'result-item';
                ghqP.innerHTML = `<span class="result-dimension">T·ªïng ƒëi·ªÉm GHQ-12:</span> <span class="score">${results.ghq12.totalScore}</span> <span class="interpretation-text">${getGHQ12Interpretation(results.ghq12.totalScore)}</span>`;
                ghqSection.appendChild(ghqP);

                resultsContentDiv.appendChild(ghqSection);
            }

            // Display DASS-21 Results
            if (results.dass21) {
                const dassSection = document.createElement('div');
                dassSection.className = 'result-section';

                const dassTitle = document.createElement('h3');
                dassTitle.textContent = 'K·∫øt qu·∫£ DASS-21';
                dassSection.appendChild(dassTitle);

                const depressionP = document.createElement('p');
                depressionP.className = 'result-item';
                depressionP.innerHTML = `<span class="result-dimension">ƒêi·ªÉm Tr·∫ßm c·∫£m:</span> <span class="score">${results.dass21['Tr·∫ßm c·∫£m']}</span> <span class="interpretation-text ${getDASS21InterpretationLevel(results.dass21['Tr·∫ßm c·∫£m'], 'Tr·∫ßm c·∫£m')}">${getDASS21InterpretationText(results.dass21['Tr·∫ßm c·∫£m'], 'Tr·∫ßm c·∫£m')}</span>`;
                dassSection.appendChild(depressionP);

                const anxietyP = document.createElement('p');
                anxietyP.className = 'result-item';
                anxietyP.innerHTML = `<span class="result-dimension">ƒêi·ªÉm Lo √¢u:</span> <span class="score">${results.dass21['Lo √¢u']}</span> <span class="interpretation-text ${getDASS21InterpretationLevel(results.dass21['Lo √¢u'], 'Lo √¢u')}">${getDASS21InterpretationText(results.dass21['Lo √¢u'], 'Lo √¢u')}</span>`;
                dassSection.appendChild(anxietyP);

                const stressP = document.createElement('p');
                stressP.className = 'result-item';
                stressP.innerHTML = `<span class="result-dimension">ƒêi·ªÉm Stress:</span> <span class="score">${results.dass21['Stress']}</span> <span class="interpretation-text ${getDASS21InterpretationLevel(results.dass21['Stress'], 'Stress')}">${getDASS21InterpretationText(results.dass21['Stress'], 'Stress')}</span>`;
                dassSection.appendChild(stressP);

                resultsContentDiv.appendChild(dassSection);
            }
        }

        // --- Interpretation Helper Functions ---

        function getPERMADimensionInterpretation(score, dimension) {
             let level = "";
             let interpretation = "";

             if (score >= 8) {
                 level = "Cao";
                 interpretation = permaDimensionInterpretations[dimension].high;
             } else if (score >= 5) {
                 level = "Trung b√¨nh";
                 interpretation = permaDimensionInterpretations[dimension].medium;
             } else { // score 0-4
                 level = "Th·∫•p";
                 interpretation = permaDimensionInterpretations[dimension].low;
             }

             return `<span class="interpretation-text ${level === 'Cao' ? 'high' : (level === 'Trung b√¨nh' ? 'medium' : 'low')}">M·ª©c ƒë·ªô: ${level}. ${interpretation}</span>`;
        }

        function getPERMATotalInterpretation(average) {
             if (average >= 9.0) return permaTotalInterpretations.excellent;
             if (average >= 7.0) return permaTotalInterpretations.high;
             if (average >= 5.0) return permaTotalInterpretations.medium;
             return permaTotalInterpretations.risk; // < 5.0
        }

         function getPERMATotalInterpretationLevel(average) {
             if (average >= 9.0) return 'excellent';
             if (average >= 7.0) return 'high';
             if (average >= 5.0) return 'medium';
             return 'risk'; // < 5.0
         }


         function getDASS21InterpretationLevel(score, dimension) {
              const ranges = dass21InterpretationRanges[dimension];
              for (const range of ranges) {
                  if (score <= range.max) {
                      switch(range.level) {
                          case 'B√¨nh th∆∞·ªùng': return 'normal';
                          case 'Nh·∫π': return 'mild';
                          case 'V·ª´a': return 'moderate';
                          case 'N·∫∑ng': return 'severe';
                          case 'R·∫•t n·∫∑ng': return 'very-severe';
                      }
                  }
              }
              return ''; // Should not happen
         }


        function getDASS21InterpretationText(score, dimension) {
             const ranges = dass21InterpretationRanges[dimension];
             let level = "";
             for (const range of ranges) {
                 if (score <= range.max) {
                     level = range.level;
                     break;
                 }
             }
             const interpretationDetail = dass21InterpretationText[level];
             return `M·ª©c ƒë·ªô: ${level}. ${interpretationDetail}`;
        }

         function getGHQ12Interpretation(score) {
              let interpretation = "";
              let interpretationClass = "normal";

              if (score > ghq12Interpretation.threshold2.score) {
                   interpretation = ghq12Interpretation.threshold2.text;
                   interpretationClass = "very-severe"; // Or risk
              } else if (score > ghq12Interpretation.threshold1.score) {
                   interpretation = ghq12Interpretation.threshold1.text;
                   interpretationClass = "risk"; // Or severe
              } else {
                  interpretation = "ƒêi·ªÉm trong gi·ªõi h·∫°n b√¨nh th∆∞·ªùng, cho th·∫•y kh√¥ng c√≥ b·∫±ng ch·ª©ng ƒë√°ng k·ªÉ v·ªÅ v·∫•n ƒë·ªÅ s·ª©c kh·ªèe t√¢m l√Ω ph·ªï bi·∫øn.";
                  interpretationClass = "normal";
              }
              return interpretation; // Interpretation text includes level implicitly
         }


        // --- Charting ---

        function displayPERMAChart(permaDimensionScores) {
            const chartContainer = document.getElementById('perma-chart-container');
            chartContainer.style.display = 'block'; // Show the chart container

            const ctx = document.getElementById('perma-chart').getContext('2d');

            if (permaChart) {
                permaChart.destroy();
            }

            permaChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['C·∫£m x√∫c t√≠ch c·ª±c (P)', 'S·ª± g·∫Øn k·∫øt (E)', 'M·ªëi quan h·ªá (R)', '√ù nghƒ©a (M)', 'Th√†nh t·ª±u (A)'],
                    datasets: [{
                        label: 'ƒêi·ªÉm c√°c kh√≠a c·∫°nh PERMA',
                        data: [permaDimensionScores.P, permaDimensionScores.E, permaDimensionScores.R, permaDimensionScores.M, permaDimensionScores.A],
                        backgroundColor: 'rgba(74, 144, 226, 0.2)',
                        borderColor: 'rgba(74, 144, 226, 1)',
                        pointBackgroundColor: 'rgba(74, 144, 226, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(74, 144, 226, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { display: true },
                            suggestedMin: 0,
                            suggestedMax: 10,
                            ticks: {
                                 beginAtZero: true,
                                 stepSize: 2,
                                 maxTicksLimit: 6,
                                 callback: function(value) {
                                     // Only show integer ticks
                                     if (Number.isInteger(value)) {
                                         return value;
                                     }
                                 }
                             },
                             pointLabels: {
                                 font: { size: 11 }
                             },
                              grid: { circular: true } // Make radar grid circular
                        }
                    },
                    plugins: {
                         legend: { position: 'top' },
                         tooltip: {
                              callbacks: {
                                   label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        label += context.parsed.r.toFixed(2); // Show score with 2 decimals
                                        const dimensionLetter = context.label.split(' ')[0]; // Get 'P', 'E', etc.
                                        // Find full interpretation text for tooltip
                                        const interpretationSpan = getPERMADimensionInterpretation(context.parsed.r, dimensionLetter);
                                        const interpretationText = interpretationSpan.replace(/<[^>]*>/g, ''); // Remove HTML tags
                                        return [label, interpretationText];
                                   }
                              }
                         }
                    }
                }
            });
        }


        // --- Data Persistence ---
        function saveResults(results) {
            // Saving only the latest result for this example
            localStorage.setItem('latestAssessmentResults', JSON.stringify(results));
            console.log('Results saved:', results);
        }

        function loadResults() {
            const savedResults = localStorage.getItem('latestAssessmentResults');
            if (savedResults) {
                allResults = JSON.parse(savedResults);
                console.log('Results loaded:', allResults);
                // Optionally pre-fill name/date fields if saved
                document.getElementById('name').value = allResults.name || '';
                document.getElementById('date').value = allResults.date || '';

                 // Restore selections on questions? This would be complex, maybe skip for simplicity.
                 // Instead, rely on displaying loaded results in the results tab.
            }
        }

        function clearData() {
            localStorage.removeItem('latestAssessmentResults');
            allResults = {}; // Clear in-memory results
            document.getElementById('results-content').innerHTML = '<p class="completion-message">D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x√≥a. Vui l√≤ng ho√†n th√†nh l·∫°i c√°c b√†i test.</p>';
             document.getElementById('name').value = '';
             document.getElementById('date').value = '';

             // Clear selected options visually
             document.querySelectorAll('.option').forEach(option => option.classList.remove('selected'));
             document.querySelectorAll('.question').forEach(q => q.removeAttribute('data-selected-value'));


            if (permaChart) {
                permaChart.destroy();
                permaChart = null;
            }
             document.getElementById('perma-chart-container').style.display = 'none';

            alert('ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu ƒë√£ l∆∞u trong tr√¨nh duy·ªát.');
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
             // Add "T√≠nh ƒëi·ªÉm" button inside the Results tab, before the clear button
             const resultsContentDiv = document.getElementById('results-content');
             const calculateButton = document.createElement('button');
             calculateButton.textContent = 'T√≠nh ƒëi·ªÉm & Xem k·∫øt qu·∫£';
             calculateButton.onclick = calculateAllScores;
             resultsContentDiv.parentNode.insertBefore(calculateButton, resultsContentDiv); // Insert before results-content div


            renderQuestions('perma-questions', permaQuestions, permaLabelsLeft.concat(permaLabelsRight), '0-10'); // 0-10 scale
             renderQuestions('ghq12-questions', ghq12Questions, ghq12Labels, '0-3', ghq12ReverseScored); // 0-3 scale, with reverse scoring
             renderQuestions('dass21-questions', dass21Questions, dass21Labels, '0-3'); // 0-3 scale

            loadResults(); // Load any previously saved results on page load
            // Initial tab is set by CSS and the openTab call below

            // Open the default tab (PERMA) on load
            document.querySelector('.tabs .tab-button').click();
        });


    </script>
</body>
</html>
